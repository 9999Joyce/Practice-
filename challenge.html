<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç”Ÿå­—æŒ‘æˆ°æ¨¡å¼</title>

<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: "Microsoft JhengHei", sans-serif;
    background: #e0f7fa;
    overflow: hidden;
  }

  header {
    background: #0097a7;
    color: white;
    padding: 10px;
    text-align: center;
    font-size: 20px;
    font-weight: bold;
  }

  /* ===== æ§åˆ¶å€ï¼ˆä¸€å®šè¦åœ¨æœ€ä¸Šå±¤ï¼‰ ===== */
  #control-panel {
    position: relative;
    z-index: 1000;
    background: white;
    padding: 10px;
    text-align: center;
  }

  select, button {
    font-size: 16px;
    padding: 6px 10px;
    margin: 5px;
  }

  /* ===== æ‰å­—å€ ===== */
  #game-area {
    position: absolute;
    top: 90px;
    left: 0;
    width: 100%;
    height: calc(100% - 90px);
    overflow: hidden;
    pointer-events: none; /* é—œéµï¼šä¸åƒäº‹ä»¶ */
  }

  .falling-char {
    position: absolute;
    font-size: 36px;
    font-weight: bold;
    color: #006064;
  }

  /* ===== å¯«å­—å€ ===== */
  #writer-area {
    position: fixed;
    right: 10px;
    bottom: 10px;
    width: 260px;
    height: 260px;
    background: white;
    border: 4px solid #0097a7;
    z-index: 500;
  }

  #status {
    position: fixed;
    left: 10px;
    bottom: 20px;
    font-size: 18px;
    font-weight: bold;
    color: #006064;
    z-index: 500;
  }
</style>
</head>

<body>

<header>ğŸ® ç”Ÿå­—æŒ‘æˆ°æ¨¡å¼</header>

<div id="control-panel">
  <select id="gradeSelect"></select>
  <button onclick="startGame()">é–‹å§‹æŒ‘æˆ°</button>
</div>

<div id="game-area"></div>
<div id="writer-area"></div>
<div id="status">è«‹é¸æ“‡å¹´ç´š</div>

<script>
/* ==============================
   â˜…â˜…â˜… åœ¨é€™è£¡è²¼ä¸Šä½ çš„ GAS URL â˜…â˜…â˜…
================================ */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxidqajTK3-sSxz7iA0Py1K5qsox1-8ELKotZzAKJYH09SMIXjWUb6PYdvqaHNauEv1/exec";

/* ===== å…¨åŸŸè®Šæ•¸ ===== */
let database = {};
let wordsPool = [];
let currentChar = null;
let writer = null;
let fallingTimer = null;

/* ===== è®€å–è³‡æ–™ ===== */
fetch(GAS_URL)
  .then(res => res.text())
  .then(text => {
    if (!text || text.length < 10) {
      document.getElementById("status").innerText = "âŒ GAS æ²’æœ‰å›è³‡æ–™";
      return;
    }

    document.getElementById("status").innerText =
      "âœ… å·²æ”¶åˆ°è³‡æ–™ï¼Œé•·åº¦ï¼š" + text.length;

    const data = JSON.parse(text);
    database = data;
    initGradeSelect();

    document.getElementById("status").innerText =
      "âœ… å¹´ç´šæ•¸ï¼š" + Object.keys(database).length;
  })
  .catch(err => {
    document.getElementById("status").innerText =
      "âŒ è§£æå¤±æ•—ï¼š" + err.message;
  });


/* ===== åˆå§‹åŒ–å¹´ç´šï¼ˆï¼å­©å­ï¼‰ ===== */
function initGradeSelect() {
  const sel = document.getElementById("gradeSelect");
  sel.innerHTML = "";
  Object.keys(database).forEach(child => {
    const opt = document.createElement("option");
    opt.value = child;
    opt.textContent = child;
    sel.appendChild(opt);
  });
}

/* ===== é–‹å§‹éŠæˆ² ===== */
function startGame() {
  clearInterval(fallingTimer);
  document.getElementById("game-area").innerHTML = "";

  const grade = document.getElementById("gradeSelect").value;
  wordsPool = [];

  Object.values(database[grade]).forEach(semester =>
    Object.values(semester).forEach(lesson => {
      lesson.split("").forEach(c => {
        if (/[\u4e00-\u9fa5]/.test(c)) wordsPool.push(c);
      });
    })
  );

  shuffle(wordsPool);
  nextChar();
}

/* ===== ä¸‹ä¸€å€‹å­— ===== */
function nextChar() {
  if (wordsPool.length === 0) {
    document.getElementById("status").innerText = "ğŸ‰ å…¨éƒ¨å®Œæˆï¼Œåšå¾—å¥½ï¼";
    clearInterval(fallingTimer);
    return;
  }

  currentChar = wordsPool.shift();
  document.getElementById("status").innerText = `è«‹å¯«ï¼š${currentChar}`;
  startFalling(currentChar);
  startWriter(currentChar);
}

/* ===== æ‰è½å‹•ç•«ï¼ˆæ…¢é€Ÿï¼‰ ===== */
function startFalling(char) {
  const game = document.getElementById("game-area");
  const div = document.createElement("div");
  div.className = "falling-char";
  div.innerText = char;
  div.style.left = Math.random() * (window.innerWidth - 50) + "px";
  div.style.top = "0px";
  game.appendChild(div);

  let top = 0;
  fallingTimer = setInterval(() => {
    top += 0.3;   // â˜… å·²æ”¾æ…¢ï¼ˆæ‰‹æ©Ÿå‹å–„ï¼‰
    div.style.top = top + "px";
    if (top > window.innerHeight) {
      clearInterval(fallingTimer);
      game.removeChild(div);
      nextChar();
    }
  }, 20);
}

/* ===== å¯«å­— ===== */
function startWriter(char) {
  document.getElementById("writer-area").innerHTML = "";
  writer = HanziWriter.create("writer-area", char, {
    width: 260,
    height: 260,
    padding: 5,
    showOutline: true,
    strokeAnimationSpeed: 1
  });

  writer.quiz({
    onComplete: () => {
      clearInterval(fallingTimer);
      document.getElementById("game-area").innerHTML = "";
      nextChar();
    }
  });
}

/* ===== å·¥å…· ===== */
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
</script>

</body>
</html>
